---
# https://www.talos.dev/v1.7/kubernetes-guides/network/deploying-cilium/#method-2-helm-manifests-install
- name: Add a repository
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/
    # force_update: true

- name: Render Cilium helm chart templates
  ansible.builtin.command: >
    helm template
      cilium
      cilium/cilium
      {{ talos_cilium_chart_values }}
  register: talos_helm_template_render
  changed_when: false # because of randomly generated TLS certs
  no_log: true # contains sensitive info
  tags:
    - talos_upgrade_cilium

- name: Write cilium template in one temporary file
  ansible.builtin.template:
    src: cilium.patch.j2
    dest: "{{ talos_config_dir }}/cilium.yaml"
    mode: "0600"
  changed_when: false # because of randomly generated TLS certs
  no_log: true # contains sensitive info
  tags:
    - talos_upgrade_cilium
